name: Auto Generate Index and Log

on:
  push:
    paths:
      - '*.webp'
  workflow_dispatch:

# üõ°Ô∏è Ch·ªëng ch·∫°y song song ƒë·ªÉ tr√°nh ghi ƒë√® file log.json
concurrency:
  group: log-update
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Generate Index and Append Log
        run: |
          python3 -m pip install Pillow
          python3 -c "
          import os, json, datetime
          from PIL import Image

          # --- 1. ƒê·ªåC D·ªÆ LI·ªÜU C≈® ---
          old_indices = set()
          if os.path.exists('images.json'):
              try:
                  with open('images.json', 'r') as f:
                      old_data = json.load(f)
                      old_indices = {int(item['i']) for item in old_data if 'i' in item}
              except: pass

          # --- 2. QU√âT TH·ª∞C T·∫æ & T·∫†O INDEX M·ªöI ---
          new_results = []
          files = [f for f in os.listdir('.') if f.endswith('.webp')]
          files.sort(key=lambda x: int(x.split('.')[0]) if x.split('.')[0].isdigit() else 0, reverse=True)
          
          current_indices = set()
          for filename in files:
              try:
                  num = int(filename.split('.')[0])
                  current_indices.add(num)
                  with Image.open(filename) as img:
                      w, h = img.size
                      new_results.append({'i': num, 'w': w, 'h': h})
              except: pass
          
          with open('images.json', 'w') as f:
              json.dump(new_results, f)

          # --- 3. T·∫†O NH·∫¨T K√ù KI·ªÇU BOT (T√ÅCH RI√äNG T·ª™NG D√íNG) ---
          added = sorted(list(current_indices - old_indices))
          deleted = sorted(list(old_indices - current_indices))

          if added or deleted:
              log_file = 'log.json'
              logs = []
              if os.path.exists(log_file):
                  try:
                      with open(log_file, 'r', encoding='utf-8') as f:
                          logs = json.load(f)
                  except: pass

              now = datetime.datetime.now() + datetime.timedelta(hours=7)
              time_str = now.strftime('%H:%M %d/%m')

              # Th√™m t·ª´ng d√≤ng ri√™ng bi·ªát cho m·ªói ·∫£nh
              for a in added:
                  logs.append({'m': f'üì• ƒê√£ th√™m ·∫£nh {a} l√∫c {time_str}', 't': int(now.timestamp() * 1000)})
              
              for d in deleted:
                  logs.append({'m': f'üóë ƒê√£ x√≥a ·∫£nh {d} l√∫c {time_str}', 't': int(now.timestamp() * 1000)})

              logs = logs[-500:] # L∆∞u 500 d√≤ng g·∫ßn nh·∫•t
              with open(log_file, 'w', encoding='utf-8') as f:
                  json.dump(logs, f, ensure_ascii=False, indent=2)
          "

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add images.json log.json
          git commit -m "Auto-update index and log [skip ci]" || echo "No changes"
          git push
