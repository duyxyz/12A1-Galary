name: Bot Thu Ky Nong Bong

on:
  push:
    branches:
      - main # Chá»‰ bÃ¡o khi Ä‘áº©y vÃ o nhÃ¡nh chÃ­nh

jobs:
  telegram:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Preparing Information
        id: vars
        run: |
          # Láº¥y danh sÃ¡ch file thay Ä‘á»•i (áº¢nh má»›i, xÃ³a áº£nh...)
          ADDED=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} --diff-filter=A | grep -E '\.webp$' || true)
          DELETED=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} --diff-filter=D | grep -E '\.webp$' || true)
          
          # Äáº¿m sá»‘ lÆ°á»£ng
          COUNT_ADD=$(echo "$ADDED" | grep -c '\.webp' || echo 0)
          COUNT_DEL=$(echo "$DELETED" | grep -c '\.webp' || echo 0)
          
          echo "added_count=$COUNT_ADD" >> $GITHUB_OUTPUT
          echo "deleted_count=$COUNT_DEL" >> $GITHUB_OUTPUT
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Sending Notification
        if: steps.vars.outputs.added_count > 0 || steps.vars.outputs.deleted_count > 0
        run: |
          REPO="12A1-Galary"
          ACTOR="${{ github.actor }}"
          SHA="${{ steps.vars.outputs.sha_short }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          
          MSG="ğŸ“¸ <b>THÆ¯ VIá»†N 12A1 Cáº¬P NHáº¬T</b>%0A%0A"
          MSG="$MSGğŸ‘¤ <b>NgÆ°á»i thá»±c hiá»‡n:</b> <code>$ACTOR</code>%0A"
          
          if [ "${{ steps.vars.outputs.added_count }}" -gt 0 ]; then
            MSG="$MSGğŸ“¥ <b>Má»›i thÃªm:</b> <code>${{ steps.vars.outputs.added_count }} áº£nh má»›i</code>%0A"
          fi
          
          if [ "${{ steps.vars.outputs.deleted_count }}" -gt 0 ]; then
            MSG="$MSGğŸ—‘ <b>ÄÃ£ xÃ³a:</b> <code>${{ steps.vars.outputs.deleted_count }} áº£nh</code>%0A"
          fi
          
          MSG="$MSG%0AğŸŒ <a href='$COMMIT_URL'>Xem chi tiáº¿t (SHA: $SHA)</a>"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_TO }}" \
          -d text="$MSG" \
          -d parse_mode="HTML" \
          -d disable_web_page_preview=true
