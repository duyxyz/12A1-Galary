name: Bot Thu Ky Nong Bong

on:
  push:
    paths:
      - '*.webp'
  workflow_dispatch:

jobs:
  notify-and-log:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Preparing Information & Telegram
        id: vars
        run: |
          # L·∫•y danh s√°ch file thay ƒë·ªïi (ch·ªâ quan t√¢m ƒë·∫øn file s·ªë .webp ·ªü g·ªëc)
          ADDED=$(git diff --name-only --diff-filter=A ${{ github.event.before }} ${{ github.event.after }} | grep "^[0-9]\+\.webp$" | sed 's/\.webp//g' | tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g')
          DELETED=$(git diff --name-only --diff-filter=D ${{ github.event.before }} ${{ github.event.after }} | grep "^[0-9]\+\.webp$" | sed 's/\.webp//g' | tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g')
          
          echo "added=$ADDED" >> $GITHUB_OUTPUT
          echo "deleted=$DELETED" >> $GITHUB_OUTPUT
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

          # G·ª≠i Telegram (gi·ªØ nguy√™n phong c√°ch c≈©)
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          
          MSG="üè† <b>GITHUB SYSTEM UPDATE</b>%0A%0A"
          MSG="$MSGüë§ <b>User:</b> <code>$ACTOR</code>%0A"
          MSG="$MSGüì¶ <b>Commit:</b> <code>$COMMIT_MSG</code>%0A"
          
          if [ ! -z "$ADDED" ]; then MSG="$MSGüì• <b>Added:</b> <code>$ADDED</code>%0A"; fi
          if [ ! -z "$DELETED" ]; then MSG="$MSGüóë <b>Deleted:</b> <code>$DELETED</code>%0A"; fi
          
          MSG="$MSG%0Aüåê <a href='$COMMIT_URL'>Review on GitHub</a>"

          # Ch·ªâ g·ª≠i Tele n·∫øu c√≥ token
          if [ ! -z "${{ secrets.TELEGRAM_TOKEN }}" ]; then
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_TO }}" \
            -d text="$MSG" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true
          fi

      - name: Update log.json (1 line only, no icons)
        run: |
          python3 -c "
          import os, json, datetime
          
          added = '${{ steps.vars.outputs.added }}'
          deleted = '${{ steps.vars.outputs.deleted }}'
          
          if added or deleted:
              now = datetime.datetime.now() + datetime.timedelta(hours=7)
              time_str = now.strftime('%H:%M %d/%m')
              
              parts = []
              if added: parts.append(f'V·ª´a th√™m ·∫£nh: {added}')
              if deleted: parts.append(f'ƒê√£ x√≥a ·∫£nh: {deleted}')
              
              final_msg = '. '.join(parts) + f' l√∫c {time_str}'
              log_data = [{'m': final_msg, 't': int(now.timestamp() * 1000)}]
              
              with open('log.json', 'w', encoding='utf-8') as f:
                  json.dump(log_data, f, ensure_ascii=False, indent=2)
          "

      - name: Commit log.json
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add log.json
          if git diff --staged --quiet; then
            echo "No changes in log.json"
          else
            git commit -m "Auto-update log.json [skip ci]"
            git push
          fi
