name: Bot Thu Ky Nong Bong

on: [push]

jobs:
  telegram:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Preparing Information
        id: vars
        run: |
          # L·∫•y danh s√°ch file thay ƒë·ªïi
          ADDED=$(git diff --name-only --diff-filter=A ${{ github.event.before }} ${{ github.event.after }} | tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g')
          DELETED=$(git diff --name-only --diff-filter=D ${{ github.event.before }} ${{ github.event.after }} | tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g')
          MODIFIED=$(git diff --name-only --diff-filter=M ${{ github.event.before }} ${{ github.event.after }} | tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g')
          
          echo "added=$ADDED" >> $GITHUB_OUTPUT
          echo "deleted=$DELETED" >> $GITHUB_OUTPUT
          echo "modified=$MODIFIED" >> $GITHUB_OUTPUT
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Sending Notification
        run: |
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          ACTOR="${{ github.actor }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          SHA="${{ steps.vars.outputs.sha_short }}"
          
          # X√¢y d·ª±ng n·ªôi dung tin nh·∫Øn v·ªõi phong c√°ch Technical 2D
          MSG="ÔøΩ <b>GITHUB SYSTEM UPDATE Branch Test</b>%0A%0A"
          MSG="$MSGüë§ <b>User:</b> <code>$ACTOR</code>%0A"
          MSG="$MSGÔøΩ <b>Repo:</b> <code>$REPO</code>%0A"
          MSG="$MSGüîò <b>Branch:</b> <code>$BRANCH</code>%0A%0A"
          
          MSG="$MSGÔøΩ <b>Commit:</b>%0A<code>$COMMIT_MSG</code>%0A%0A"
          
          if [ ! -z "${{ steps.vars.outputs.added }}" ]; then
            MSG="$MSGüì• <b>Added:</b>%0A<code>${{ steps.vars.outputs.added }}</code>%0A"
          fi
          
          if [ ! -z "${{ steps.vars.outputs.modified }}" ]; then
            MSG="$MSGÔøΩ <b>Modified:</b>%0A<code>${{ steps.vars.outputs.modified }}</code>%0A"
          fi
          
          if [ ! -z "${{ steps.vars.outputs.deleted }}" ]; then
            MSG="$MSGüóë <b>Deleted:</b>%0A<code>${{ steps.vars.outputs.deleted }}</code>%0A"
          fi
          
          MSG="$MSG%0Aüåê <a href='$COMMIT_URL'>Review on GitHub (SHA: $SHA)</a>%0A"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_TO }}" \
          -d text="$MSG" \
          -d parse_mode="HTML" \
          -d disable_web_page_preview=true
          
